<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title><code>pytest_container</code></title>
<meta name="author" content="Dan ƒåerm√°k"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./node_modules/reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./node_modules/reveal.js/dist/theme/simple.css" id="theme"/>

<link rel="stylesheet" href="./node_modules/@fortawesome/fontawesome-free/css/all.min.css"/>

<link rel="stylesheet" href="./custom-style.css"/>
<link rel="stylesheet" href="./node_modules/reveal.js/plugin/highlight/zenburn.css"/>
<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './node_modules/reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide"><h2 class="title"><code>pytest_container</code></h2>
<p class="subtitle" style="color: Gray;">Testing Container Images with Python and Pytest</p>
<p class="author">Dan ƒåerm√°k</p>
<div style="float:left"><a href="https://events.opensuse.org/conferences/oSC25" target="_blank"><img src="./media/oSCon2025Logo.svg" height="80px" style="margin-bottom:-12px"/>&nbsp; oSC25</a></div>
<div style="float:right;font-size:35px;"><p xmlns:dct="http://purl.org/dc/terms/" xmlns:cc="http://creativecommons.org/ns#"><a href="https://creativecommons.org/licenses/by/4.0" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
CC BY 4.0 <i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i></a></p></div>
</section>
<section>
<section id="slide-orgb1ca142">
<h2 id="orgb1ca142">who -u</h2>
<p>
Dan ƒåerm√°k
</p>

<p>
 <div style="float:center">
 <table class="who-table">
 <tr><td><i class="fab fa-suse"></i></td><td> Software Developer @SUSE</td></tr>
 <tr><td><i class="fab fa-fedora"></i></td><td> i3 SIG, Package maintainer</td></tr>
 <tr><td><i class="far fa-heart"></i></td><td> Developer Tools, Testing and Documentation, Home Automation</td></tr>
 <tr></tr>
 <tr></tr>
 <tr><td><i class="fa-solid fa-globe"></i></td><td> <a href="https://dancermak.name/">https://dancermak.name</a></td></tr>
 <tr><td><i class="fab fa-github"></i></td><td> <a href="https://github.com/dcermak/">dcermak</a> </td></tr>
 <tr><td><i class="fab fa-mastodon"></i></td><td> <a href="https://mastodon.social/@Defolos">@Defolos@mastodon.social</a></td></tr>
 </table>
 </div>
</p>
</section>
</section>
<section>
<section id="slide-orgc9ebd12">
<h2 id="orgc9ebd12">Why not <code>/bin/sh</code>?</h2>
<p>
When shell scripts are:
</p>
<ul>
<li class="fragment appear">portable / run everywhere</li>
<li class="fragment appear">fast üèéÔ∏è</li>
<li class="fragment appear">everyone understands them</li>

</ul>

<p class="fragment (appear)">
Until they aren't üí•
</p>
</section>
</section>
<section>
<section id="slide-org02db741">
<h2 id="org02db741">Why <code>pytest_container</code>?</h2>
<ul>
<li class="fragment appear"><i class="fa-solid fa-cloud-sun-rain"></i> shell scripts are brittle</li>
<li class="fragment appear"><i class="fa-solid fa-cloud-arrow-down"></i> automatically pull, build, launch &amp; cleanup containers</li>
<li class="fragment appear">use <a href="https://testinfra.readthedocs.io/">testinfra</a> for convenience</li>
<li class="fragment appear"><i class="fa-solid fa-shuffle"></i> parallel test execution via <a href="https://github.com/pytest-dev/pytest-xdist">pytest-xdist</a></li>
<li class="fragment appear">find &amp; bind free ports</li>
<li class="fragment appear"><i class="fa-solid fa-boxes-stacked"></i> create &amp; destroy pods</li>
<li class="fragment appear"><i class="fa-solid fa-broom"></i> create and cleanup container volumes &amp; bind mounts</li>
<li class="fragment appear"><i class="fa-solid fa-box-archive"></i> run the same test on multiple container images</li>
<li class="fragment appear">supports <i class="fa-brands fa-docker"></i> docker and podman transparently</li>
<li class="fragment appear">works with <i class="fa-brands fa-python"></i> Python 3.6+ and on <code>x86_64</code>, <code>aarch64</code>, <code>s390x</code>, <code>ppcle64</code></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgc0af075">
<h2 id="orgc0af075">Basic Example</h2>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='1-3|5-9'>TW = Container(
    url="registry.opensuse.org/opensuse/tumbleweed:latest"
)

@pytest.mark.parametrize("container", [TW], indirect=True)
def test_etc_os_release_present(container: ContainerData):
    assert container.connection.file(
        "/etc/os-release"
    ).exists
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org85cb3b1">
<h2 id="org85cb3b1">Use Cases</h2>
<ul>
<li class="fragment appear"><i class="fa-solid fa-box-open"></i> system tests of base containers</li>
<li class="fragment appear"><i class="fa-solid fa-database"></i> test applications inside containers</li>
<li class="fragment appear"><i class="fa-solid fa-boxes-stacked"></i> run tests of your application on multiple OS'</li>

</ul>
</section>
</section>
<section>
<section id="slide-orgb6992af">
<h2 id="orgb6992af"><code>pytest</code> fixtures</h2>
<aside class="notes">
<ul>
<li>fixtures also support indirect parametrization</li>

</ul>

</aside>

<ul>
<li data-fragment-index="1" class="fragment appear">fixtures for setup &amp; teardown  <i class="fa-solid fa-broom"></i></li>

</ul>


<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="python" >def test_ehlo(smtp_connection):
    response, msg = smtp_connection.ehlo()
    assert response == 250
</code></pre>
</div>

<ul>
<li data-fragment-index="3" class="fragment appear">test <a href="https://docs.pytest.org/en/stable/how-to/parametrize.html">parametrization</a></li>

</ul>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="3"  ><code class="python" >@pytest.mark.parametrize("x", [0, 1])
@pytest.mark.parametrize("y", [2, 3])
def test_foo(x: int, y: int):
    # do something with x &amp; y here
</code></pre>
</div>
</section>
</section>
<section>
<section id="slide-org9ce36e3">
<h2 id="org9ce36e3">Usage examples</h2>
<div class="outline-text-2" id="text-org9ce36e3">
</div>
</section>
<section id="slide-org3fc2505">
<h3 id="org3fc2505">Build a new container for tests</h3>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='2|3-6|1-7|9-15'>WEB_SERVER = DerivedContainer(
    base="registry.opensuse.org/opensuse/leap:latest",
    containerfile="""RUN zypper -n in python3 \
    &amp;&amp; echo "Hello Green World!" &gt; index.html
ENTRYPOINT ["/usr/bin/python3", "-m", "http.server"]
"""
)

@pytest.mark.parametrize(
    "container", [WEB_SERVER], indirect=True
)
def test_python_installed(container: ContainerData):
    assert container.connection.package(
        "python3"
    ).is_installed
</code></pre>
</div>
</section>
<section id="slide-org9440af1">
<h3 id="org9440af1">Dependencies between containers</h3>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='1-3|4-7|8-11|13,15'>TW = Container(
    url="registry.opensuse.org/opensuse/tumbleweed:latest"
)
NGINX = DerivedContainer(
    base=TW,
    containerfile="RUN zypper -n in nginx",
)
NGINX_DEBUG = DerivedContainer(
    base=NGINX,
    containerfile="RUN zypper -n in gdb nginx-debuginfo"
)

CONTAINER_IMAGES=[NGINX_DEBUG]

def test_nginx(auto_container): ...
</code></pre>
</div>
</section>
<section id="slide-org12a2af8">
<h3 id="org12a2af8">Get a free port on the host</h3>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='3|1-4|6-9|12|6-14'>WEB_SERVER = DerivedContainer(
    # snip
    forwarded_ports=[PortForwarding(container_port=8000)],
)

@pytest.mark.parametrize(
    "container", [WEB_SERVER], indirect=True
)
def test_port_forward(container: ContainerData, host):
    cmd = (
        "curl --fail localhost:"
        + str(container.forwarded_ports[0].host_port)
    )
    host.check_output(cmd)
</code></pre>
</div>
</section>
<section id="slide-org3eaf929">
<h3 id="org3eaf929"><code>HEALTHCHECK</code></h3>
<aside class="notes">
<ul>
<li>will wait for healthcheck</li>

</ul>

</aside>

<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='5|3-5|1-6|9-10|12-14|9-15'>WEB_SERVER = DerivedContainer(
    # snip
    containerfile="""
ENTRYPOINT ["/usr/bin/python3", "-m", "http.server"]
HEALTHCHECK CMD curl --fail http://0.0.0.0:8000""",
)


@pytest.mark.parametrize("container", [WEB_SERVER], indirect=True)
def test_server_up(container, container_runtime):
    assert (
        container_runtime.get_container_health(
            container.container_id
        ) == ContainerHealth.HEALTHY
    )
</code></pre>
</div>
</section>
<section id="slide-orgd8e5228">
<h3 id="orgd8e5228">Create a Pod</h3>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='1-4|2|3|6-9|10-14'>MEDIAWIKI_FPM_POD = Pod(
    containers=[MEDIAWIKI_FPM_CONTAINER, NGINX_FPM_PROXY],
    forwarded_ports=[PortForwarding(container_port=80)],
)

@pytest.mark.parametrize(
    "pod", [MEDIAWIKI_FPM_POD], indirect=True
)
def test_port_forward(pod: PodData, host):
    cmd = (
        "curl --fail localhost:"
        + str(pod.forwarded_ports[0].host_port)
    )
    host.check_output(cmd)
</code></pre>
</div>
</section>
<section id="slide-org3d0c7f1">
<h3 id="org3d0c7f1">Run mutable tests</h3>
<p data-fragment-index="1" class="fragment (appear)">
use the <code>container_per_test</code> fixture:
</p>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="python" data-line-numbers='4,11|1-5|8-14'>@pytest.mark.parametrize(
    "container_per_test", [TW], indirect=True
)
def test_rm_rf(container_per_test):
    container_per_test.connection.check_output("rm -rf /")


@pytest.mark.parametrize(
    "container_per_test", [TW], indirect=True
)
def test_uninstall_zypper(container_per_test):
    container_per_test.connection.check_output(
        "rpm -e --nodeps zypper"
    )
</code></pre>
</div>
</section>
<section id="slide-orge0dc30d">
<h3 id="orge0dc30d">üîé Inspect containers</h3>
<div class="org-src-container">

<pre   ><code class="python" data-line-numbers='1-4|5|7|7,8|7,8,10-13'>@pytest.mark.parametrize(
    "container", [MY_IMAGE], indirect=True
)
def test_inspect(container: ContainerData):
    inspect = container.inspect

    assert inspect.config.user == "me"
    assert inspect.config.cmd == ["/bin/sh"]

    assert (
        "HOME" in inspect.config.env
        and inspect.config.env["HOME"] == "/src/"
    )
</code></pre>
</div>
</section>
<section id="slide-org3dae721">
<h3 id="org3dae721">Container Volumes</h3>
<p>
Bind mounts
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="python" data-line-numbers='4|3-5|1-6|9-12|13|9-14'>ROOTDIR_BIND_MOUNTED = DerivedContainer(
    base="registry.opensuse.org/opensuse/tumbleweed",
    volume_mounts=[
        BindMount("/src/", host_path=get_rootdir())
    ],
)


@pytest.mark.parametrize(
    "container", [ROOTDIR_BIND_MOUNTED], indirect=True
)
def test_bind_mount_cwd(container: ContainerData):
    vol = container.container.volume_mounts[0]
    assert container.connection.file("/src/").exists
</code></pre>
</div>

</section>
<section id="slide-org3dae721-split">

<p>
Container volumes
</p>
<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="python" data-line-numbers='3|1-4'>WITH_VAR_LOG_VOLUME = DerivedContainer(
    base="registry.opensuse.org/opensuse/tumbleweed",
    volume_mounts=[ContainerVolume("/var/log/")],
)
</code></pre>
</div>
</section>
<section id="slide-org4d77481">
<h3 id="org4d77481">Use the same container globally</h3>
<p data-fragment-index="1" class="fragment (appear)">
use the <code>auto_container</code> / <code>auto_container_per_test</code> fixtures:
</p>

<div class="org-src-container">

<pre  class="fragment (appear)" data-fragment-index="2"  ><code class="python" data-line-numbers='1|4,7'>CONTAINER_IMAGES = [TW, LEAP, SLE]


def test_etc_os_release(auto_container): ...


def test_zypper_rm_works(auto_container_per_test): ...
</code></pre>
</div>
</section>
<section id="slide-org1ea2824">
<h3 id="org1ea2824">Pick the Container Engine</h3>
<div class="org-src-container">

<pre   ><code class="bash" >export CONTAINER_RUNTIME=docker
pytest -vv
</code></pre>
</div>
</section>
<section id="slide-orgb689930">
<h3 id="orgb689930">Run tests in parallel</h3>
<div class="org-src-container">

<pre   ><code class="bash" data-line-numbers='1|3|5'>pip install pytest-xdist
# or
poetry add --group dev pytest-xdist

pytest -vv -- -n auto
</code></pre>
</div>
</section>
<section id="slide-org1f5ae88">
<h3 id="org1f5ae88">üßπ Automatic cleanup</h3>
<ul>
<li class="fragment appear">containers</li>
<li class="fragment appear">volumes</li>
<li class="fragment appear">pods</li>
<li class="fragment appear">temporary directories</li>
<li class="fragment appear">‚ö†Ô∏èImages and intermediate layers are retained ‚ö†Ô∏è</li>

</ul>
</section>
</section>
<section>
<section id="slide-org1958de3">
<h2 id="org1958de3">Roadmap</h2>
<ul>
<li class="fragment appear">better entrypoint testing (<a href="https://github.com/dcermak/pytest_container/issues/206">#206</a>)</li>
<li class="fragment appear">support for foreign architecture containers (<a href="https://github.com/dcermak/pytest_container/pull/183">#183</a>)</li>
<li class="fragment appear">improved multistage build support (<a href="https://github.com/dcermak/pytest_container/issues/149">#149</a>)</li>

</ul>
</section>
</section>
<section>
<section id="slide-org435a0de">
<h2 id="org435a0de">Users</h2>
<ul>
<li class="fragment appear"><a href="https://github.com/SUSE/BCI-tests/">BCI testsuite</a></li>
<li class="fragment appear"><a href="https://github.com/OSInside/kiwi/tree/master/test/scripts">kiwi image builder scripts</a></li>
<li class="fragment appear"><a href="https://github.com/openSUSE/obs-service-replace_using_package_version/tree/master/integration_tests"><code>obs-service-replace_using_package_version</code> integration tests</a></li>
<li class="fragment appear"><a href="https://github.com/openSUSE/obs-scm-bridge/tree/main/test"><code>obs-scm-bridge</code> integration tests</a></li>
<li class="fragment appear"><a href="https://github.com/openSUSE/obs-service-node_modules/blob/master/test_node_modules_download.py"><code>obs-service-node_modules</code> smoke test</a></li>
<li class="fragment appear">Your project here?</li>

</ul>
</section>
</section>
<section>
<section id="slide-org3655d16">
<h2 id="org3655d16">Thanks!</h2>
<ul>
<li><a href="https://github.com/evrardjp">Jean-Philippe Evrard</a></li>
<li>QE-C Team, especially <a href="https://feldspaten.org/">Felix Niederwanger</a> and <a href="http://www.instagram.com/bake_with_jose">Jos√© Lausuch</a></li>
<li>All the <a href="https://github.com/dcermak/pytest_container/graphs/contributors">contributors &amp; testers</a></li>

</ul>
</section>
</section>
<section>
<section id="slide-org1be6672">
<h2 id="org1be6672">Give it a try!</h2>
<p>
<img src="media/github-qr.svg" height="300px"/>
</p>

<p>
 <i class="fab fa-github"></i> <a href="https://github.com/dcermak/pytest_container"><code>dcermak/pytest_container</code></a>
</p>

<p>
<i class="fa-solid fa-book"></i> <a href="https://dcermak.github.io/pytest_container/index.html"><code>dcermak.github.io/pytest_container</code></a>
</p>

<p>
<i class="fa-solid fa-person-chalkboard"></i> <a href="https://dcermak.github.io/pytest_container-presentation/pytest_container.html"><code>dcermak.github.io/pytest_container-presentation</code></a>
</p>
</section>
</section>
<section>
<section id="slide-org025858a">
<h2 id="org025858a">Questions?</h2>
<p class="fragment appear">
Answers!
</p>

<p class="fragment appear">
Suggestions?
</p>
<p class="fragment appear">
üëâ <a href="https://github.com/dcermak/pytest_container/issues" class="fragment appear"><code>github.com/dcermak/pytest_container/issues</code></a>
</p>
</section>
</section>
</div>
</div>
<script src="./node_modules/reveal.js/dist/reveal.js"></script>
<script src="./node_modules/reveal.js/plugin/highlight/highlight.js"></script>
<script src="./node_modules/reveal.js/plugin/notes/notes.js"></script>


<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
plugins: [RevealHighlight, RevealNotes, history],
transition: 'none', hash: true
});

</script>
</body>
</html>
